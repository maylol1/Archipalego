<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>UNO Game - Refactored</title>
<style>
  body {
    background: #1c1c1c;
    color: white;
    font-family: "Poppins", sans-serif;
    margin: 0;
    overflow-x: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  h1 {
    margin-top: 20px;
    color: #ff4444;
    letter-spacing: 2px;
  }

  #game {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 10px;
  }

  .hand {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    margin: 15px;
    gap: 5px;
  }

  .card {
    width: 60px;
    height: 90px;
    border-radius: 10px;
    background: gray;
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    user-select: none;
  }

  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0 10px #fff3;
  }

  .red { background: #d32f2f; }
  .yellow { background: #fbc02d; color: black; }
  .green { background: #388e3c; }
  .blue { background: #1976d2; }
  .wild { background: linear-gradient(45deg, red, yellow, green, blue); }

  #top-card {
    width: 80px;
    height: 120px;
    border-radius: 15px;
    margin: 20px;
    font-size: 1.2em;
  }

  #color-picker {
    display: none;
    justify-content: center;
    gap: 10px;
    margin: 10px;
  }

  .color-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    outline: none;
  }

  .color-btn.red { background: #d32f2f; }
  .color-btn.yellow { background: #fbc02d; }
  .color-btn.green { background: #388e3c; }
  .color-btn.blue { background: #1976d2; }

  .info {
    margin: 10px;
    font-size: 0.9em;
  }

  #reset-btn {
    background: #ff4444;
    color: white;
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    margin-bottom: 10px;
    font-weight: bold;
  }

  #reset-btn:hover { background: #ff6666; }

</style>
</head>
<body>
  <h1>UNO Game</h1>

  <button id="reset-btn">Restart Game</button>

  <div id="game">
    <div id="top-card" class="card"></div>

    <div id="color-picker">
      <button id="pick-red" class="color-btn red"></button>
      <button id="pick-yellow" class="color-btn yellow"></button>
      <button id="pick-green" class="color-btn green"></button>
      <button id="pick-blue" class="color-btn blue"></button>
    </div>

    <div class="info" id="turn-info">Your turn!</div>

    <div id="hand-0" class="hand"></div>
    <div class="info" id="count-0">0 cards</div>

    <div id="hand-1" class="hand"></div>
    <div class="info" id="count-1">0 cards</div>
    <div id="hand-2" class="hand"></div>
    <div class="info" id="count-2">0 cards</div>
    <div id="hand-3" class="hand"></div>
    <div class="info" id="count-3">0 cards</div>
  </div>

  <script>
  /* ============================================================
     UNO GAME SCRIPT â€“ Refactored + Smarter AI + Freeze Fix
     ============================================================ */

  let deck = [];
  let players = [];
  let current = 0;
  let direction = 1;
  let topCard = null;
  let topColor = null;
  let busy = false;
  let waitingColor = false;

  const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
  const log = (msg) => console.log(`[UNO] ${msg}`);

  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  /* --- Deck --- */
  function buildDeck() {
    const colors = ["red", "yellow", "green", "blue"];
    const values = ["0","1","2","3","4","5","6","7","8","9","skip","reverse","draw2"];
    deck = [];
    for (const c of colors) {
      for (const v of values) {
        deck.push({ color: c, value: v });
        if (v !== "0") deck.push({ color: c, value: v });
      }
    }
    for (let i = 0; i < 4; i++) {
      deck.push({ color: "wild", value: "wild" });
      deck.push({ color: "wild", value: "wild4" });
    }
    shuffle(deck);
  }

  function drawCard() {
    if (deck.length === 0) reshuffle();
    return deck.pop();
  }

  function reshuffle() {
    log("Reshuffling deck...");
    const keep = topCard;
    buildDeck();
    deck = deck.filter(c => !(c.color === keep.color && c.value === keep.value));
    shuffle(deck);
  }

  /* --- Rendering --- */
  function renderAll() {
    renderTopCard();
    renderHands();
  }

  function renderTopCard() {
    const el = document.getElementById("top-card");
    el.className = `card ${topCard.color}`;
    el.textContent = topCard.value.toUpperCase();
  }

  function renderHands() {
    for (let i = 0; i < players.length; i++) {
      const handDiv = document.getElementById(`hand-${i}`);
      if (!handDiv) continue;
      handDiv.innerHTML = "";
      const p = players[i];
      p.hand.forEach((card, idx) => {
        const c = document.createElement("div");
        c.className = `card ${card.color}`;
        c.textContent = i === 0 ? card.value.toUpperCase() : "UNO";
        if (i === 0 && canPlayCard(card)) {
          c.onclick = () => playerPlay(idx);
        }
        handDiv.appendChild(c);
      });
      document.getElementById(`count-${i}`).textContent = `${p.hand.length} cards`;
    }
  }

  /* --- Init --- */
  function initGame() {
    buildDeck();
    players = [];
    for (let i = 0; i < 4; i++) players.push({ hand: [] });
    for (let i = 0; i < 7; i++) players.forEach(p => p.hand.push(drawCard()));
    topCard = drawCard();
    topColor = topCard.color;
    current = 0;
    direction = 1;
    waitingColor = false;
    busy = false;
    renderAll();
    updateTurn();
  }

  /* --- Logic --- */
  function canPlayCard(card) {
    return (card.color === topColor || card.value === topCard.value || card.color === "wild");
  }

  function getNextPlayer() {
    return (current + direction + players.length) % players.length;
  }

  function applyCardEffect(card) {
    switch (card.value) {
      case "skip": current = getNextPlayer(); break;
      case "reverse": direction *= -1; if (players.length === 2) current = getNextPlayer(); break;
      case "draw2":
        const t = getNextPlayer();
        for (let i = 0; i < 2; i++) players[t].hand.push(drawCard());
        current = t; break;
      case "wild4":
        const n = getNextPlayer();
        for (let i = 0; i < 4; i++) players[n].hand.push(drawCard());
        current = n; break;
    }
  }

  function endTurn() {
    current = getNextPlayer();
    updateTurn();
  }

  /* --- Player actions --- */
  async function playerPlay(idx) {
    if (busy || waitingColor) return;
    const card = players[0].hand[idx];
    if (!canPlayCard(card)) return;
    busy = true;
    players[0].hand.splice(idx, 1);
    topCard = { ...card };
    topColor = card.color === "wild" ? topColor : card.color;
    renderAll();
    await handleAfterPlay(card, 0);
    busy = false;
  }

  async function handleAfterPlay(card, pid) {
    if (card.color === "wild") {
      if (pid === 0) {
        waitingColor = true;
        await chooseColorUI();
        waitingColor = false;
      } else {
        await aiChooseColor(pid);
      }
    }
    applyCardEffect(card);
    renderAll();
    await sleep(700);
    if (players[pid].hand.length === 0) {
      alert(pid === 0 ? "You win!" : `Player ${pid + 1} wins!`);
      return initGame();
    }
    endTurn();
  }

  function chooseColorUI() {
    return new Promise(resolve => {
      const picker = document.getElementById("color-picker");
      picker.style.display = "flex";
      ["red", "yellow", "green", "blue"].forEach(color => {
        const btn = document.getElementById(`pick-${color}`);
        btn.onclick = () => {
          topColor = color;
          picker.style.display = "none";
          resolve();
        };
      });
    });
  }

  /* --- AI --- */
  async function aiTurn() {
    const pid = current;
    const p = players[pid];
    busy = true;
    document.getElementById("turn-info").textContent = `Player ${pid + 1}'s turn...`;
    await sleep(1000 + Math.random() * 500);

    const playable = p.hand.filter(c => canPlayCard(c));
    if (playable.length === 0) {
      const drawn = drawCard();
      p.hand.push(drawn);
      renderAll();
      await sleep(600);
      if (canPlayCard(drawn)) {
        await aiPlay(pid, drawn);
      } else {
        busy = false;
        endTurn();
      }
      return;
    }

    // Priority
    const card = playable.find(c => c.value === "wild4") ||
                 playable.find(c => c.value === "draw2") ||
                 playable.find(c => c.value === "skip") ||
                 playable.find(c => c.value === "reverse") ||
                 playable[Math.floor(Math.random() * playable.length)];

    await aiPlay(pid, card);
    busy = false;
  }

  async function aiPlay(pid, card) {
    const p = players[pid];
    const idx = p.hand.findIndex(c => c === card);
    if (idx !== -1) p.hand.splice(idx, 1);
    topCard = { ...card };
    topColor = card.color === "wild" ? topColor : card.color;
    renderAll();
    await handleAfterPlay(card, pid);
  }

  async function aiChooseColor(pid) {
    const hand = players[pid].hand;
    const counts = {};
    for (const c of hand) {
      if (c.color === "wild") continue;
      counts[c.color] = (counts[c.color] || 0) + 1;
    }
    const best = Object.entries(counts).sort((a, b) => b[1] - a[1])[0]?.[0] || "red";
    topColor = best;
    log(`AI ${pid} chose ${best}`);
    await sleep(500);
  }

  /* --- Turn flow --- */
  async function updateTurn() {
    renderAll();
    if (waitingColor || busy) return;
    if (current === 0) {
      document.getElementById("turn-info").textContent = "Your turn!";
    } else {
      await aiTurn();
    }
  }

  /* --- Events --- */
  document.getElementById("reset-btn").onclick = initGame;

  window.onload = initGame;
  </script>
</body>
</html>
